<!DOCTYPE html>
<html>
<head>
    <title data-i18n="title">VPN Share Tool - Discovery Server</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 1rem; }
        .container { max-width: 1200px; margin: auto; background-color: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #333; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        input[type="text"], input[type="submit"], button { padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        input[type="submit"], button { background-color: #007bff; color: white; cursor: pointer; border: none; }
        button.delete { background-color: #dc3545; }
        button.rename { background-color: #ffc107; }
        ul { list-style: none; padding: 0; }
        li { background-color: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .url-info { flex-grow: 1; word-break: break-all; }
        .url-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; width: 100%; justify-content: flex-end; }
        @media (min-width: 600px) { .url-actions { width: auto; margin-top: 0; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>VPN Share Tool - Discovery Server</h1>
        <div class="grid">
            <div>
                <h2>Active Servers</h2>
                <ul id="server-list-ul"></ul>
                <h2>All Active Proxies</h2>
                <ul id="proxy-list-ul"></ul>
            </div>
            <div>
                <h2>Tagged URLs</h2>
                <form id="tagged-url-form">
                    <input type="text" name="tag" placeholder="Tag (e.g., PHIS Production)" required>
                    <input type="text" name="url" placeholder="URL" required>
                    <input type="submit" value="Save Tagged URL">
                </form>
                <ul id="tagged-list-ul"></ul>
            </div>
        </div>
    </div>
    <script>
        const serverListUl = document.getElementById('server-list-ul');
        const proxyListUl = document.getElementById('proxy-list-ul');
        const taggedListUl = document.getElementById('tagged-list-ul');
        const taggedUrlForm = document.getElementById('tagged-url-form');

        const fetchServers = async () => { /* ... existing implementation ... */ };
        const fetchProxies = async () => { /* ... existing implementation ... */ };

        const fetchTaggedURLs = async () => {
            try {
                const response = await fetch('/tagged-urls');
                if (!response.ok) throw new Error('Failed to fetch');
                const urls = await response.json();
                taggedListUl.innerHTML = '';
                urls.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).forEach(u => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="url-info">
                            <strong>${u.tag}</strong><br>
                            <small>${u.url}</small>
                        </div>
                        <div class="url-actions">
                            <button onclick="createProxy('${u.url}')">Create Proxy</button>
                            <button class="rename" onclick="renameTag('${u.id}', '${u.tag}')">Rename</button>
                            <button class="delete" onclick="deleteTag('${u.id}')">Delete</button>
                        </div>
                    `;
                    taggedListUl.appendChild(li);
                });
            } catch (err) { console.error('Error fetching tagged URLs:', err); }
        };

        taggedUrlForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(taggedUrlForm);
            const tag = formData.get('tag');
            const url = formData.get('url');
            try {
                const response = await fetch('/tagged-urls', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag, url })
                });
                if (response.ok) {
                    fetchTaggedURLs();
                    taggedUrlForm.reset();
                } else {
                    alert('Error saving URL.');
                }
            } catch (err) { alert('Error: ' + err.message); }
        });

        window.createProxy = async (url) => {
             try {
                const response = await fetch('/create-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(`Proxy created: ${data.shared_url}`);
                    fetchProxies();
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (err) { alert('Error: ' + err.message); }
        };

        window.renameTag = async (id, oldTag) => {
            const newTag = prompt('Enter new tag name:', oldTag);
            if (newTag && newTag !== oldTag) {
                try {
                    const response = await fetch(`/tagged-urls/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tag: newTag })
                    });
                    if (response.ok) fetchTaggedURLs();
                    else alert('Error renaming tag.');
                } catch (err) { alert('Error: ' + err.message); }
            }
        };

        window.deleteTag = async (id) => {
            if (confirm('Are you sure you want to delete this tagged URL?')) {
                try {
                    const response = await fetch(`/tagged-urls/${id}`, { method: 'DELETE' });
                    if (response.ok) fetchTaggedURLs();
                    else alert('Error deleting tag.');
                } catch (err) { alert('Error: ' + err.message); }
            }
        };

        // Initial and periodic fetching
        fetchServers();
        fetchProxies();
        fetchTaggedURLs();
        setInterval(fetchServers, 5000);
        setInterval(fetchProxies, 5000);
    </script>
</body>
</html>